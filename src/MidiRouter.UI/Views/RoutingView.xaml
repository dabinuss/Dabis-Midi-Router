<UserControl x:Class="MidiRouter.UI.Views.RoutingView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d"
             d:DesignHeight="450"
             d:DesignWidth="800"
             Focusable="True"
             PreviewKeyDown="OnPreviewKeyDown"
             PreviewMouseMove="OnRootPreviewMouseMove"
             PreviewMouseLeftButtonUp="OnRootPreviewMouseLeftButtonUp">
    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="8" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="8" />
            <RowDefinition Height="2*" />
            <RowDefinition Height="8" />
            <RowDefinition Height="3*" />
            <RowDefinition Height="8" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <DockPanel Grid.Row="0">
            <TextBlock DockPanel.Dock="Left"
                       VerticalAlignment="Center"
                       FontWeight="SemiBold"
                       Text="{Binding ServiceHealthStatus}" />
            <Button DockPanel.Dock="Right"
                    Content="Ports aktualisieren"
                    Command="{Binding RefreshEndpointsCommand}"
                    MinWidth="140" />
        </DockPanel>

        <Border Grid.Row="2"
                BorderBrush="#33000000"
                BorderThickness="1"
                Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="10" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="6" />
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="8" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBlock Grid.ColumnSpan="3"
                           FontWeight="SemiBold"
                           Text="Port-Verwaltung" />

                <StackPanel Grid.Row="2" Grid.Column="0" Orientation="Horizontal">
                    <TextBox Width="220"
                             Margin="0,0,8,0"
                             Text="{Binding NewPortName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                    <Button Content="Interner Port erstellen"
                            ToolTip="Erstellt einen app-internen Loopback-Port (nicht als globaler Windows-MIDI-Port sichtbar)."
                            Command="{Binding CreatePortCommand}"
                            MinWidth="130" />
                </StackPanel>

                <StackPanel Grid.Row="2" Grid.Column="2" Orientation="Horizontal">
                    <TextBox x:Name="EditPortNameTextBox"
                             Width="220"
                             Margin="0,0,8,0"
                             Text="{Binding EditPortName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                    <Button Content="Port umbenennen"
                            Command="{Binding RenamePortCommand}"
                            MinWidth="135"
                            Margin="0,0,8,0" />
                    <Button Content="Port loschen"
                            Command="{Binding DeletePortCommand}"
                            MinWidth="120" />
                </StackPanel>

                <StackPanel Grid.Row="4"
                            Grid.ColumnSpan="3"
                            Orientation="Horizontal"
                            VerticalAlignment="Center">
                    <TextBlock Text="Filter:"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0" />
                    <TextBox Width="220"
                             Margin="0,0,8,0"
                             ToolTip="Suche in Name, ID, Typ, Eigentumer, Richtung"
                             Text="{Binding PortSearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
                    <ComboBox Width="160"
                              ItemsSource="{Binding PortDirectionFilters}"
                              SelectedItem="{Binding SelectedPortDirectionFilter, Mode=TwoWay}" />
                </StackPanel>
            </Grid>
        </Border>

        <Border Grid.Row="4"
                BorderBrush="#33000000"
                BorderThickness="1"
                Padding="10">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="10" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="6" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Column="0"
                           FontWeight="SemiBold"
                           Text="Eigene Ports" />
                <TextBlock Grid.Column="2"
                           FontWeight="SemiBold"
                           Text="Systemports" />

                <DataGrid Grid.Row="2"
                          Grid.Column="0"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          IsReadOnly="True"
                          ItemsSource="{Binding AppPorts}"
                          SelectedItem="{Binding SelectedPort, Mode=TwoWay}"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="2*" />
                        <DataGridTextColumn Header="Richtung" Binding="{Binding Direction}" Width="*" />
                        <DataGridTextColumn Header="Gesendet" Binding="{Binding SentData}" Width="*" />
                    </DataGrid.Columns>
                </DataGrid>

                <DataGrid Grid.Row="2"
                          Grid.Column="2"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          IsReadOnly="True"
                          ItemsSource="{Binding SystemPorts}"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="2*" />
                        <DataGridTextColumn Header="Richtung" Binding="{Binding Direction}" Width="*" />
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Border>

        <Border Grid.Row="6"
                BorderBrush="#335F7A"
                BorderThickness="1.5"
                CornerRadius="6"
                Padding="10"
                Background="#F8FBFF">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="8" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <Border Grid.Row="0"
                        Background="#E6EFF8"
                        BorderBrush="#335F7A"
                        BorderThickness="1"
                        CornerRadius="4"
                        Padding="8,6">
                    <TextBlock FontWeight="SemiBold"
                               Text="Routing-Visuals" />
                </Border>

                <Grid x:Name="RouteDesignerGrid"
                      Grid.Row="2"
                      SizeChanged="OnRouteDesignerSizeChanged">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2.2*" />
                    <ColumnDefinition Width="1.6*" />
                    <ColumnDefinition Width="2.2*" />
                </Grid.ColumnDefinitions>

                <Canvas x:Name="RoutingCanvas"
                        Grid.ColumnSpan="3"
                        Panel.ZIndex="0"
                        ClipToBounds="True" />
                <Canvas x:Name="DragPreviewCanvas"
                        Grid.ColumnSpan="3"
                        Panel.ZIndex="50"
                        IsHitTestVisible="False"
                        ClipToBounds="True" />

                <Border Grid.Column="0"
                        Panel.ZIndex="2"
                        BorderBrush="#22000000"
                        BorderThickness="1"
                        Padding="8"
                        Margin="0,0,8,0">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top"
                                   FontWeight="SemiBold"
                                   Margin="0,0,0,8"
                                   Text="IN Ports (inkl. In/Out)" />
                        <ListBox x:Name="LeftPortsListBox"
                                 BorderThickness="0"
                                 ScrollViewer.CanContentScroll="False"
                                 VirtualizingStackPanel.IsVirtualizing="False"
                                 ItemsSource="{Binding LeftRoutePorts}"
                                 SelectedValuePath="Id"
                                 SelectedValue="{Binding SelectedSourceEndpointId, Mode=TwoWay}">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="0,2"
                                            Padding="8,6"
                                            BorderBrush="#22000000"
                                            BorderThickness="1"
                                            Background="#FAFAFA"
                                            Tag="left"
                                            Cursor="Hand"
                                            PreviewMouseLeftButtonDown="OnRouteItemPreviewMouseLeftButtonDown">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <StackPanel>
                                                <TextBlock FontWeight="SemiBold"
                                                           Text="{Binding Name}" />
                                                <TextBlock FontSize="11"
                                                           Foreground="#66000000"
                                                           Text="{Binding Meta}" />
                                            </StackPanel>

                                            <Button Grid.Column="1"
                                                    Width="24"
                                                    Height="24"
                                                    Margin="8,0,0,0"
                                                    Content=">"
                                                    Cursor="Hand"
                                                    Tag="left"
                                                    Loaded="OnConnectorLoaded"
                                                    Unloaded="OnConnectorUnloaded"
                                                    PreviewMouseLeftButtonDown="OnConnectorPreviewMouseLeftButtonDown"
                                                    Click="OnConnectorClick" />
                                            <Button Grid.Column="2"
                                                    Width="24"
                                                    Height="24"
                                                    Margin="6,0,0,0"
                                                    Content="x"
                                                    Cursor="Hand"
                                                    ToolTip="Verbindung loschen"
                                                    Click="OnDeletePortRouteClick" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </DockPanel>
                </Border>

                <Border Grid.Column="1"
                        Panel.ZIndex="1"
                        IsHitTestVisible="False"
                        BorderBrush="#22000000"
                        BorderThickness="1"
                        Padding="8"
                        Margin="4,0">
                    <StackPanel>
                        <TextBlock FontWeight="SemiBold"
                                   Text="Routing Canvas" />
                        <TextBlock Margin="0,6,0,0"
                                   TextWrapping="Wrap"
                                   Foreground="#66000000"
                                   Text="Connector von links nach rechts (oder umgekehrt) ziehen. Linien zeigen aktive Routen direkt." />
                    </StackPanel>
                </Border>

                <Border Grid.Column="2"
                        Panel.ZIndex="2"
                        BorderBrush="#22000000"
                        BorderThickness="1"
                        Padding="8"
                        Margin="8,0,0,0">
                    <DockPanel>
                        <TextBlock DockPanel.Dock="Top"
                                   FontWeight="SemiBold"
                                   Margin="0,0,0,8"
                                   Text="OUT Ports (inkl. In/Out)" />
                        <ListBox x:Name="RightPortsListBox"
                                 BorderThickness="0"
                                 ScrollViewer.CanContentScroll="False"
                                 VirtualizingStackPanel.IsVirtualizing="False"
                                 ItemsSource="{Binding RightRoutePorts}"
                                 SelectedValuePath="Id"
                                 SelectedValue="{Binding SelectedTargetEndpointId, Mode=TwoWay}">
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border Margin="0,2"
                                            Padding="8,6"
                                            BorderBrush="#22000000"
                                            BorderThickness="1"
                                            Background="#FAFAFA"
                                            Tag="right"
                                            Cursor="Hand"
                                            PreviewMouseLeftButtonDown="OnRouteItemPreviewMouseLeftButtonDown">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>

                                            <Button Grid.Column="0"
                                                    Width="24"
                                                    Height="24"
                                                    Margin="0,0,8,0"
                                                    Content="&lt;"
                                                    Cursor="Hand"
                                                    Tag="right"
                                                    Loaded="OnConnectorLoaded"
                                                    Unloaded="OnConnectorUnloaded"
                                                    PreviewMouseLeftButtonDown="OnConnectorPreviewMouseLeftButtonDown"
                                                    Click="OnConnectorClick" />
                                            <Button Grid.Column="1"
                                                    Width="24"
                                                    Height="24"
                                                    Margin="0,0,8,0"
                                                    Content="x"
                                                    Cursor="Hand"
                                                    ToolTip="Verbindung loschen"
                                                    Click="OnDeletePortRouteClick" />

                                            <StackPanel Grid.Column="2">
                                                <TextBlock FontWeight="SemiBold"
                                                           Text="{Binding Name}" />
                                                <TextBlock FontSize="11"
                                                           Foreground="#66000000"
                                                           Text="{Binding Meta}" />
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </DockPanel>
                </Border>
                </Grid>
            </Grid>
        </Border>

        <TextBlock Grid.Row="8"
                   Margin="0,8,0,0"
                   Foreground="#B00020"
                   Text="{Binding ValidationMessage}" />
    </Grid>
</UserControl>
